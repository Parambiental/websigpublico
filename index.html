// --- CAPAS BASE ---
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19,
  attribution:
    '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
});

const opentopo = L.tileLayer(
  "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 17,
    attribution:
      'Map data: &copy; <a href="https://opentopomap.org">OpenTopoMap</a>, ' +
      'SRTM | Map style: &copy; OpenTopoMap (CC-BY-SA)',
  }
);

const stamenToner = L.tileLayer(
  "https://stamen-tiles.a.ssl.fastly.net/toner/{z}/{x}/{y}.png",
  {
    maxZoom: 20,
    attribution:
      'Map tiles by <a href="http://stamen.com">Stamen Design</a>, ' +
      'under CC BY 3.0. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>',
  }
);

// --- MAPA ---
const map = L.map("map", {
  center: [-25.2637, -57.5759],
  zoom: 13,
  layers: [osm],
});

// --- CAPAS BASE CONTROL ---
const baseLayers = {
  "OpenStreetMap": osm,
  "OpenTopoMap": opentopo,
  "Stamen Toner": stamenToner,
};

// --- CAPAS GEOJSON (VACÍAS - se cargarán después) ---
// Ejemplo de capas temáticas GeoJSON libres de Paraguay / Asunción
const lotesCatastrales = L.geoJSON(null, {
  style: { color: "#FF0000", weight: 1, fillOpacity: 0.3 },
  onEachFeature: (feature, layer) => {
    if (feature.properties && feature.properties.id) {
      layer.bindPopup(`Lote ID: ${feature.properties.id}`);
    }
  },
});

const zonasUrbanas = L.geoJSON(null, {
  style: { color: "#0000FF", weight: 2, fillOpacity: 0.2 },
  onEachFeature: (feature, layer) => {
    if (feature.properties && feature.properties.nombre) {
      layer.bindPopup(`Zona Urbana: ${feature.properties.nombre}`);
    }
  },
});

// Añadir capas vacías a un grupo para controlarlas
const overlays = {
  "Lotes Catastrales": lotesCatastrales,
  "Zonas Urbanas": zonasUrbanas,
};

// Control de capas base y superpuestas
L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);

// --- CONTROL DE ESCALA ---
L.control.scale({ position: "bottomleft", metric: true, imperial: false }).addTo(map);

// --- CONTROL DE GEOCODIFICACIÓN (con Nominatim) ---
const geocoder = L.Control.geocoder({
  defaultMarkGeocode: false,
}).on("markgeocode", function(e) {
  const bbox = e.geocode.bbox;
  const poly = L.polygon([
    bbox.getSouthEast(),
    bbox.getNorthEast(),
    bbox.getNorthWest(),
    bbox.getSouthWest(),
  ]).addTo(map);
  map.fitBounds(poly.getBounds());
}).addTo(map);

// --- CONTROL DE GEOLOCALIZACIÓN ---
L.control
  .locate({
    position: "topleft",
    flyTo: true,
    strings: {
      title: "Mostrar mi ubicación",
    },
  })
  .addTo(map);

// --- CONTROL DE DIBUJO (Leaflet.draw) ---
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);

const drawControl = new L.Control.Draw({
  position: "topright",
  draw: {
    polygon: true,
    polyline: true,
    rectangle: true,
    circle: false,
    marker: true,
    circlemarker: false,
  },
  edit: {
    featureGroup: drawnItems,
  },
});
map.addControl(drawControl);

map.on(L.Draw.Event.CREATED, function (event) {
  const layer = event.layer;
  drawnItems.addLayer(layer);
});

// --- CONTROL DE MEDICIÓN (distancia y área) ---
const measureControl = new L.Control.Measure({
  position: "topleft",
  primaryLengthUnit: "meters",
  primaryAreaUnit: "sqmeters",
  activeColor: "#db4a29",
  completedColor: "#9b2d14",
});
measureControl.addTo(map);

// --- CONTROL DE LEYENDA SIMPLE ---
const legend = L.control({ position: "bottomright" });

legend.onAdd = function (map) {
  const div = L.DomUtil.create("div", "info legend");
  div.innerHTML = `
    <h4>Leyenda</h4>
    <i style="background: #FF0000; opacity:0.5"></i> Lotes Catastrales<br>
    <i style="background: #0000FF; opacity:0.3"></i> Zonas Urbanas<br>
  `;
  return div;
};
legend.addTo(map);

// --- CARGA DE CAPAS GEOJSON DINÁMICAMENTE ---

// Función para cargar GeoJSON desde URL (ejemplo)
function cargarGeoJSON(url, capa) {
  fetch(url)
    .then((res) => res.json())
    .then((data) => {
      capa.clearLayers();
      capa.addData(data);
    })
    .catch((err) => console.error("Error cargando GeoJSON: ", err));
}

// Ejemplo: cargar lotes catastrales desde archivo local o URL
cargarGeoJSON("data/lotes_catastrales.geojson", lotesCatastrales);
cargarGeoJSON("data/zonas_urbanas.geojson", zonasUrbanas);

// --- MÁS HERRAMIENTAS (Ejemplos) ---
// 1. Snap para dibujo (para ajustar vértices)
// 2. Exportar a GeoJSON (de drawnItems o capas)
// 3. Herramienta de búsqueda avanzada
// 4. Herramientas de análisis espacial (buffers, intersecciones)

// Para esas funcionalidades puedo ayudarte a integrarlas según tus necesidades.

// --- SUGERENCIA PARA CAPAS CATASTRALES DE ASUNCIÓN ---
// Verificar si Catastro de Asunción tiene WFS/WMS público:
// Ejemplo WMS (si disponible):
// const wmsCatastro = L.tileLayer.wms('https://.../wms', {layers: 'catastro', format: 'image/png', transparent: true});
// overlays["Catastro Asunción (WMS)"] = wmsCatastro;
// map.addLayer(wmsCatastro);

// --- Finalmente agregar las nuevas capas al control de capas ---
L.control.layers(baseLayers, overlays, { collapsed: false }).addTo(map);
